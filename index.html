<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Babaq avlodlari shajarasi</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f8fb;
      text-align: center;
      overflow: hidden;
    }

    header {
      background: linear-gradient(90deg, #003c96, #0055d4);
      color: white;
      font-size: 24px;
      font-weight: bold;
      padding: 20px;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .controls {
      margin: 15px 0;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }

    .tree-container {
      position: relative;
      width: 100%;
      height: calc(100vh - 150px);
      overflow: hidden;
      cursor: grab;
    }

    .node {
      position: absolute;
      display: inline-block;
      background: white;
      border: 2px solid #007bff;
      border-radius: 50px;
      padding: 10px 18px;
      color: #333;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: 0.3s;
      white-space: nowrap;
    }

    .node:hover {
      background: #e8f0ff;
      transform: scale(1.05);
    }

    .selected {
      background: #007bff !important;
      color: white !important;
      box-shadow: 0 0 15px rgba(0,123,255,0.7);
    }

    svg {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      overflow: visible;
    }
  </style>
</head>
<body>

  <header>üå≥ Babaq avlodlari shajarasi</header>

  <div class="controls">
    <button onclick="addChild()">‚ûï O‚Äòg‚Äòil qo‚Äòshish</button>
    <button onclick="deleteSelected()">‚ùå Belgilangan shaxsni o‚Äòchirish</button>
    <button onclick="saveTree()">üíæ Saqlash</button>
    <button onclick="resetTree()">‚ôªÔ∏è Qayta tiklash</button>
  </div>

  <div class="tree-container" id="treeContainer">
    <div id="treeWrapper">
      <svg id="lines"></svg>
    </div>
  </div>

  <script>
    const defaultTree = {
      name: "Babaq",
      children: [
        {
          name: "Dauletnazar",
          children: [
            { name: "rustem", children: [{ name: "dwd", children: [] }] },
            { name: "azamat", children: [] }
          ]
        },
        {
          name: "Xakim Bolis",
          children: [
            { name: "palenshe", children: [] },
            { name: "tolenshe", children: [] }
          ]
        }
      ]
    };

    let treeData = JSON.parse(localStorage.getItem("babaqTree")) || structuredClone(defaultTree);
    let selectedNodeName = null;

    function computeLayout(node, depth = 0, xStart = 0) {
      const levelGapY = 140;
      const siblingGapX = 160;

      if (!node.children || node.children.length === 0) {
        node.width = 1;
        node.x = xStart;
        node.y = depth * levelGapY;
        return 1;
      }

      let totalWidth = 0;
      for (let child of node.children) {
        totalWidth += computeLayout(child, depth + 1, xStart + totalWidth);
      }

      node.width = totalWidth;
      node.x = xStart + totalWidth / 2 - 0.5;
      node.y = depth * levelGapY;
      return totalWidth;
    }

    function renderTree() {
      const container = document.getElementById("treeContainer");
      const wrapper = document.getElementById("treeWrapper");
      const svg = document.getElementById("lines");
      wrapper.querySelectorAll(".node").forEach(n => n.remove());
      svg.innerHTML = "";

      computeLayout(treeData);

      const nodePositions = {};
      function collectPositions(node) {
        nodePositions[node.name] = node;
        node.children.forEach(collectPositions);
      }
      collectPositions(treeData);

      for (const key in nodePositions) {
        const n = nodePositions[key];
        const div = document.createElement("div");
        div.className = "node" + (selectedNodeName === n.name ? " selected" : "");
        div.innerText = n.name;
        div.style.left = `${n.x * 160 + 100}px`;
        div.style.top = `${n.y + 60}px`;
        div.onclick = () => selectNode(n.name);
        wrapper.appendChild(div);
      }

      for (const key in nodePositions) {
        const parent = nodePositions[key];
        parent.children.forEach(child => {
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          const startX = parent.x * 160 + 150;
          const startY = parent.y + 100;
          const endX = child.x * 160 + 150;
          const endY = child.y + 60;
          const curve = `M ${startX},${startY} C ${startX},${(startY + endY) / 2} ${endX},${(startY + endY) / 2} ${endX},${endY}`;
          path.setAttribute("d", curve);
          path.setAttribute("stroke", "#007bff");
          path.setAttribute("fill", "none");
          path.setAttribute("stroke-width", "2");
          svg.appendChild(path);
        });
      }
    }

    function selectNode(name) {
      selectedNodeName = selectedNodeName === name ? null : name;
      renderTree();
    }

    function findNode(node, name) {
      if (node.name === name) return node;
      for (const c of node.children) {
        const found = findNode(c, name);
        if (found) return found;
      }
      return null;
    }

    function addChild() {
      if (!selectedNodeName) return alert("Avval kimga o‚Äòg‚Äòil qo‚Äòshmoqchi ekanligingizni belgilang!");
      const newName = prompt("Yangi o‚Äòg‚Äòil ismini kiriting:");
      if (!newName) return;
      const parent = findNode(treeData, selectedNodeName);
      parent.children.push({ name: newName, children: [] });
      renderTree();
    }

    function deleteSelected() {
      if (!selectedNodeName) return alert("Avval o‚Äòchirmoqchi bo‚Äòlgan shaxsni belgilang!");
      if (selectedNodeName === "Babaq") return alert("Babaqni o‚Äòchirish mumkin emas!");
      if (confirm(`${selectedNodeName}ni o‚Äòchirmoqchimisiz?`)) {
        removeNode(treeData, selectedNodeName);
        selectedNodeName = null;
        renderTree();
      }
    }

    function removeNode(node, name) {
      node.children = node.children.filter(c => c.name !== name);
      node.children.forEach(c => removeNode(c, name));
    }

    function saveTree() {
      localStorage.setItem("babaqTree", JSON.stringify(treeData));
      alert("‚úÖ Daraxt saqlandi!");
    }

    function resetTree() {
      if (confirm("Barcha o‚Äòzgarishlar o‚Äòchadi. Qayta tiklaysizmi?")) {
        treeData = structuredClone(defaultTree);
        localStorage.setItem("babaqTree", JSON.stringify(treeData));
        selectedNodeName = null;
        renderTree();
      }
    }

    // üñ±Ô∏è Pan & Zoom
    const container = document.getElementById("treeContainer");
    const wrapper = document.getElementById("treeWrapper");
    let isPanning = false, startX, startY, offsetX = 0, offsetY = 0, scale = 1;

    container.addEventListener("mousedown", e => {
      isPanning = true;
      startX = e.clientX - offsetX;
      startY = e.clientY - offsetY;
      container.style.cursor = "grabbing";
    });

    container.addEventListener("mouseup", () => {
      isPanning = false;
      container.style.cursor = "grab";
    });

    container.addEventListener("mousemove", e => {
      if (!isPanning) return;
      offsetX = e.clientX - startX;
      offsetY = e.clientY - startY;
      wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
    });

    container.addEventListener("wheel", e => {
      e.preventDefault();
      const delta = e.deltaY < 0 ? 1.1 : 0.9;
      scale *= delta;
      scale = Math.min(Math.max(scale, 0.4), 2);
      wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
    });

    renderTree();
  </script>
</body>
</html>
